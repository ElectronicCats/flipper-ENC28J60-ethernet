#include "app_user.h"

uint8_t MAC[] = {0x54, 0x1C, 0xA3, 0x4D, 0x52, 0xC9};

/**
 * A message ID
 */

uint8_t dhcp_discover_frame[] = {
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x54, 0x1C, 0xA3, 0x4D, 0x52, 0xC9, 0x08, 0x00, 0x45,
    0x10, 0x01, 0x48, 0x00, 0x00, 0x40, 0x00, 0x40, 0x11, 0xb7, 0xe6, 0x00, 0x00, 0x00, 0x00,
    0xff, 0xff, 0xff, 0xff, 0x00, 0x44, 0x00, 0x43, 0x01, 0x34, 0x00, 0x00, 0x01, 0x01, 0x06,
    0x00, 0xf3, 0x49, 0xab, 0xa7, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfc, 0x34,
    0x97, 0xa9, 0x5a, 0xa4, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x63, 0x82,
    0x53, 0x63, 0x35, 0x01, 0x01, 0x3d, 0x07, 0x01, 0xfc, 0x34, 0x97, 0xa9, 0x5a, 0xa4, 0x37,
    0x11, 0x01, 0x02, 0x06, 0x0c, 0x0f, 0x1a, 0x1c, 0x79, 0x03, 0x21, 0x28, 0x29, 0x2a, 0x77,
    0xf9, 0xfc, 0x11, 0x39, 0x02, 0x02, 0x40, 0x32, 0x04, 0xc0, 0xa8, 0x00, 0x64, 0x0c, 0x08,
    0x61, 0x72, 0x63, 0x68, 0x57, 0x65, 0x72, 0x6f, 0xff};

// Frame length
const size_t dhcp_discover_frame_length = sizeof(dhcp_discover_frame);

int app_main(void* p) {
    UNUSED(p);

    log_info("Program Starts");

    enc28j60_t* ethernet = enc28j60_alloc(MAC);

    enc28j60_start(ethernet);

    uint8_t buffer[500];

    memset(buffer, 0, sizeof(buffer));

    uint16_t len = 0;

    while(furi_hal_gpio_read(&gpio_button_back)) {
        if(furi_hal_gpio_read(&gpio_button_ok)) {
            log_info("Send Packet");

            send_packet(ethernet, dhcp_discover_frame, dhcp_discover_frame_length);

            furi_delay_ms(200);
        }

        if(is_link_up(ethernet)) {
            len = receive_packet(ethernet, buffer, 500);

            if(len) {
                printf(
                    "-------------------------------------------------------------------------\n");
                for(uint16_t i = 0; i < len; i++) {
                    printf("%x ", buffer[i]);
                }
                printf("\n");
            }
        }

        furi_delay_ms(1);
    }

    enc28j60_deinit(ethernet);
    free_enc28j60(ethernet);

    log_info("Program FINISHES");

    return 0;
}
